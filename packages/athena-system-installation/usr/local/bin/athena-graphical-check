#!/bin/bash
#set -e
###############################################################################
# Author	:	Antonio Voza
###############################################################################
#
#   DO NOT JUST RUN THIS. EXAMINE AND JUDGE. RUN AT YOUR OWN RISK.
#
###############################################################################
echo
echo
echo "#################################"
echo "Start athena-graphical-check"
echo "#################################"
echo

while [ -e "/var/lib/pacman/db.lck" ];
do
    echo 'Pacman is not ready yet. Will try again in 5 seconds.'
    seconds=$(($seconds + 5))
    sleep 5
    if [[ "$seconds" == "30" ]]; then
        echo 'Warning: removing pacman db.lck!'
        rm /var/lib/pacman/db.lck
    fi
done

cpudetect=$(lscpu | grep -A 0 -E "Model name")

if [[ $cpudetect =~ "Intel" ]]; then
   echo "Intel CPU detected."
   pacman -S --noconfirm intel-compute-runtime
fi

gpudetect=$(lspci -k | grep -A 0 -E "(VGA compatible|3D)")

if [[ $gpudetect =~ "AMD" ]]; then
   echo "AMD GPU detected."
   pacman -S --noconfirm opencl-amd
fi

if [[ $gpudetect =~ "ATI" ]]; then
   echo "AMD GPU detected."
   pacman -S --noconfirm opencl-mesa
fi

if [[ $gpudetect =~ "NVIDIA" ]]; then
   echo "NVIDIA GPU detected."
   pacman -S --noconfirm nvidia-open-dkms nvidia-settings nvidia-utils gwe nvtop
   pacman -S --noconfirm cuda
   pacman -S --noconfirm opencl-nvidia

   sed -in '/^MODULES*/ s/"$/ nvidia nvidia_modeset nvidia_uvm nvidia_drm"/g' /etc/mkinitcpio.conf
   mkinitcpio -P
   sed -in '/^GRUB_CMDLINE_LINUX_DEFAULT*/ s/"$/ nvidia-drm.modeset=1"/g' /etc/default/grub
   grub-mkconfig -o /boot/grub/grub.cfg

   if [[ $gpudetect =~ "Intel" ]]; then
      pacman -S --noconfirm nvidia-exec optimus-manager-qt
      nvx on
      sed -i '$a__VK_LAYER_NV_optimus=NVIDIA_only\n__GLX_VENDOR_LIBRARY_NAME=nvidia' /etc/environment
   fi
fi

echo
echo "#################################"
echo "End athena-graphical-check"
echo "#################################"
echo
