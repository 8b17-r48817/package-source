pkgname=hyprland-summergruv
_pkgname=dots-hyprland
_theme=dots_summergruv
pkgver=274.fd60111f
pkgrel=1
pkgdesc="Hyprland Summer Gruv configuration."
arch=('any')
url='https://github.com/end-4/dots-hyprland'
license=("GPL")
depends=('bc' 'blueberry' 'bluez' 'boost' 'boost-libs' 'cava' 'coreutils' 'dunst' 'eww-wayland' 'findutils' 'foot' 'gawk' 'geticons-git' 'gnome-keyring' 'gojq' 'gtklock-playerctl-module' 'gtklock-powerbar-module' 'gtklock-userinfo-module' 'ibus' 'imagemagick' 'libinput-gestures' 'libqalculate' 'light' 'nerd-fonts-noto-sans-mono-extended' 'network-manager-applet' 'networkmanager' 'nlohmann-json' 'pavucontrol' 'pipewire' 'pipewire-pulse' 'plasma-browser-integration' 'playerctl' 'polkit-gnome' 'procps' 'pulseaudio' 'python-desktop-entry-lib' 'python-material-color-utilities' 'python-pywal' 'ripgrep' 'socat' 'sox' 'sway' 'swaybg' 'swayidle' 'udev' 'upower' 'util-linux' 'wget' 'wireplumber' 'wl-clipboard' 'wlogout' 'wofi')
makedepends=('git')
source=("git+https://github.com/end-4/$_pkgname"
        "$_theme::git+https://github.com/end-4/$_pkgname#branch=summer-gruv")
sha512sums=('SKIP'
            'SKIP')

pkgver() {
  cd $_pkgname

  echo $(git rev-list --count HEAD).$(git rev-parse --short HEAD)
}

package() {

  install -dm 755 "$pkgdir/etc/skel/.config"
  install -dm 755 "$pkgdir/etc/skel/.local"
  install -dm 755 "$pkgdir/etc/skel/.themes"
  install -dm 755 "$pkgdir/usr/bin"
  install -dm 755 "$pkgdir/usr/share/gnome-text-editor/styles"
  
  cd $_pkgname

  rsync -av --progress ./.config/ "$pkgdir/etc/skel/.config/"
  rsync -av --progress ./.local/ "$pkgdir/etc/skel/.local/"
  rsync -av --progress ./.themes/ "$pkgdir/etc/skel/.themes/"
  rsync -av --progress "./Import Manually/execs (add to path)/" "$pkgdir/etc/skel/.local/bin/"
  rsync -av --progress "./Import Manually/gnome-text-editor themes (Paste to root)/usr/share/gnome-text-editor/styles/" "$pkgdir/usr/share/gnome-text-editor/styles/"

  cd $srcdir/$_theme
  
  rsync -av --progress ./.themes/ "$pkgdir/etc/skel/.themes/"
  rsync -av --progress .config/hypr/colors.conf "$pkgdir/etc/skel/.config/hypr/" #Apply window border colors
  rsync -av --progress .config/eww/css "$pkgdir/etc/skel/.config/eww/" #Apply Gruvbox top bar colors
  rsync -av --progress .config/eww/images "$pkgdir/etc/skel/.config/eww/" #Apply Gruvbox top bar icon colors and wallpaper
  rsync -av --progress .config/foot "$pkgdir/etc/skel/.config/" #Apply Gruvbox theme to foot
  rsync -av --progress .config/dunst "$pkgdir/etc/skel/.config/" #Apply Gruvbox theme to dunst

  ###### TERMINAL CHECK ######

  binterm="foot" #fallback
  if pacman -Qq alacritty &> /dev/null; then
    binterm="alacritty"
  elif pacman -Qq cool-retro-term &> /dev/null; then
    binterm="cool-retro-term"
  elif pacman -Qq kitty &> /dev/null; then
    binterm="kitty"
  elif pacman -Qq konsole &> /dev/null; then
    binterm="konsole"
  elif pacman -Qq terminator &> /dev/null; then
    binterm="terminator"
  elif pacman -Qq terminology &> /dev/null; then
    binterm="terminology"
  elif pacman -Qq xfce4-terminal &> /dev/null; then
    binterm="xfce4-terminal"
  elif pacman -Qq xterm &> /dev/null; then
    binterm="xterm"
  elif pacman -Qq foot &> /dev/null; then # Fallback Wayland
    binterm="foot"
  elif pacman -Qq gnome-terminal &> /dev/null; then # Fallback generic
    binterm="gnome-terminal"
  fi
  sed -i "s/bind=SUPER,Return,exec,kitty -e fish/bind=SUPER,Return,exec,$binterm/g" "$pkgdir/etc/skel/.config/hypr/keybinds.conf"

  ###########################

  ###### BROWSER CHECK ######

  binbrowser="firefox-esr" #fallback
  if pacman -Qq brave &> /dev/null; then
    binbrowser="brave"
  elif pacman -Qq mullvad-browser &> /dev/null; then
    binbrowser="mullvad-browser"
  elif pacman -Qq firefox-esr &> /dev/null; then # Fallback at the end of if statement
    binbrowser="firefox-esr"
  fi
  sed -i "s/bind = SUPER, W, exec, firefox/bind = SUPER, W, exec, $binbrowser/g" "$pkgdir/etc/skel/.config/hypr/keybinds.conf"

  ###########################

  ###### FILE MANAGER CHECK ######

  binfilemg="nautilus" #fallback
  if pacman -Qq dolphin &> /dev/null; then
    binfilemg="dolphin"
  elif pacman -Qq thunar &> /dev/null; then
    binfilemg="thunar"
  elif pacman -Qq nautilus &> /dev/null; then # Fallback at the end of if statement
    binfilemg="nautilus"
  fi
  sed -i "s/bind = SUPER, E, exec, nautilus --new-window/bind = SUPER, E, exec, $binfilemg/g" "$pkgdir/etc/skel/.config/hypr/keybinds.conf"

  ################################
  
  ####### SET KEYBINSINGS ########

  sed -i "s/bind = SUPER, Q, killactive,/bind = ALT, Q, killactive,/g" "$pkgdir/etc/skel/.config/hypr/keybinds.conf"

  ###############################

  sed -i -e "8d;9d;12d;16d;20d" "$pkgdir/etc/skel/.config/eww/scripts/colormanage" # Remove lines that causing freezing on some buttons of the top bar

  sed -i "/^map/d" "$pkgdir/etc/skel/.config/kitty/kitty.conf" #Removing ctrl+c mapping

  sed -i '15i source ~/.bash_aliases' "$pkgdir/etc/skel/.config/fish/config.fish"

    cat > "$pkgdir/usr/bin/$pkgname" << EOF
#!/bin/sh
echo "Creation of backup directory of configuration folders..."

theme_name="Gruvbox-Dark-BL-LB"
cursor_theme="Bibata-Modern-Classic"

DIR=\$HOME/.config/hypr
if [[ -d "\$DIR" ]]; then
  rm -rf \$HOME/.config/hypr.bak
  mv \$HOME/.config/hypr \$HOME/.config/hypr.bak
fi

DIR=\$HOME/.config/fish
if [[ -d "\$DIR" ]]; then
  rm -rf \$HOME/.config/fish.bak
  mv \$HOME/.config/fish \$HOME/.config/fish.bak
fi

DIR=\$HOME/.config/foot
if [[ -d "\$DIR" ]]; then
  rm -rf \$HOME/.config/foot.bak
  mv \$HOME/.config/foot \$HOME/.config/foot.bak
fi

DIR=\$HOME/.config/kitty
if [[ -d "\$DIR" ]]; then
  rm -rf \$HOME/.config/kitty.bak
  mv \$HOME/.config/kitty \$HOME/.config/kitty.bak
fi

echo "Saved as \$HOME/.config/<dirname>.bak."
echo
echo "Copying configuration files to user's home folder..."

cp -rf /etc/skel/.config/dunst /etc/skel/.config/eww /etc/skel/.config/fish /etc/skel/.config/foot /etc/skel/.config/gtk-3.0 /etc/skel/.config/gtk-4.0 /etc/skel/.config/gtklock /etc/skel/.config/hypr /etc/skel/.config/kitty /etc/skel/.config/mpv /etc/skel/.config/waybar /etc/skel/.config/wlogout /etc/skel/.config/starship.toml \$HOME/.config/

cp -rf /etc/skel/.local/bin \$HOME/.local/

cp -rf /etc/skel/.local/share/fonts /etc/skel/.local/share/icons \$HOME/.local/share/

cp -rf /etc/skel/.config/dunst \$HOME/.config/
cp -rf /etc/skel/.config/fish \$HOME/.config/
cp -rf /etc/skel/.config/foot \$HOME/.config/
cp -rf /etc/skel/.config/kitty \$HOME/.config/

cp -rf /etc/skel/.config/gtk-3.0 \$HOME/.config/
cp -rf /etc/skel/.config/gtk-4.0 \$HOME/.config/

cp -rf /etc/skel/.themes/Tokyonight-Dark-BL-LB \$HOME/.themes/
cp -rf /etc/skel/.themes/Gruvbox-Dark-BL-LB \$HOME/.themes/

gsettings set org.gnome.desktop.interface gtk-theme \$theme_name
gsettings set org.gnome.desktop.wm.preferences theme \$theme_name
gsettings set org.gnome.desktop.interface cursor-theme \$cursor_theme

echo "Done. Reboot the system for applying the theme."
EOF

  chmod +x "$pkgdir/usr/bin/$pkgname"
}
