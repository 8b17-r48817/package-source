#!/bin/bash

echo -n "H4sIAAAAAAAAA7XSTQ6DIBAF4D2nmE0bQxq4Avc/VQMiDD+Db2hlgQr4PgYl2mnhaltvk/lB3Je16kCmZh9V52Zs/jlVRpXnrFGXqIpVqDeohsXVW1TBwiqA4iyqQijMgiqIoiymwijIQqqU/qj6mibn2y0WUYVINmrZEvcfVayhLxEv1pSApVqf3rOPGfhiMehTJs2wa+py+qSVmabrvZXWnqob5tq4EA7R7c9lBD3753KtnUTnxfKhsQhqQ0ppdY5vjX0Uf14Mmz765Y2KtyGmZOXReMIp2Ka+rldTiw2UnlzszRejmEcVIQoAAA==" | base64 -d | gunzip
echo

if [ -z "$1" ]
  then
    echo "No role ID supplied. Exiting..."
    exit 1
fi

role=$1
gitweb=0

declare -A gitsource=(["https://github.com/danielmiessler/SecLists"]="/usr/share/payloads/SecLists" ["https://github.com/DragonJAR/Security-Wordlist"]="/usr/share/payloads/Security-Wordlist")
declare -A rolepkg=(["BH"]="athena-blackhat" ["BBH"]="athena-bountyhunter" ["BT"]="athena-blueteamer" ["CR"]="athena-cracker" ["DA"]="athena-dos" ["ES"]="athena-student" ["FA"]="athena-forensic" ["MA"]="athena-malware" ["MO"]="athena-mobile" ["NA"]="athena-network" ["OS"]="athena-osint" ["RT"]="athena-redteamer" ["WP"]="athena-webpentester")

#echo $role
if [ $role = "BH" ] || [ $role = "BBH" ] || [ $role = "CR" ] || [ $role = "ES" ] || [ $role = "RT" ] || [ $role = "WP" ]; then
   gitweb=1
fi

################################################
#              UNINSTALLING TOOLS              #
################################################
printf 'Do you want to remove tools of your previous roles (y/n)? '
read answer
if [ "$answer" != "${answer#[Yy]}" ] ;then # this grammar (the #[] operator) means that the variable $answer where any Y or y in 1st position will be dropped if they exist.
   echo
   echo "Uninstalling any previous role tools..."
   echo

   for i in "${!rolepkg[@]}"
   do
      if pacman -Qq ${rolepkg[$i]} 2> /dev/null ; then
         roletools=$(pacman -Qi ${rolepkg[$i]} | grep "Depends On" | sed -e "s/Depends On      : //g" -e "s/  / /g" | awk '!seen[$0]++' | awk -F"=" '{print $1}' | awk -F".so" '{print $1}' 2> /dev/null) 
         sudo pacman -Rs --noconfirm ${rolepkg[$i]}
         sudo pacman -Rs --noconfirm $roletools 2> /dev/null
      fi
   done   
fi

################################################
#            UPDATING ARCH MIRRORS             #
################################################

echo
echo "Finding fastest Arch mirrors. Don't be scared of any WARNING message here. I'm just finding the fastest mirrors for you..."
echo

sudo reflector --age 6 --latest 21 --fastest 21 --threads 21 --sort rate --protocol https --save /etc/pacman.d/mirrorlist 2> /dev/null

echo
echo "Arch mirrors updated!"
echo

################################################
#            INSTALLING ROLE TOOLS             #
################################################

hacktools=${rolepkg[$role]}

echo
echo "Installing $hacktools tools..."
echo

sudo pacman -Syyu --noconfirm --needed $hacktools

if [ $gitweb ]; then
   echo
   read -p "Let's retrieve payload repositories! Press ENTER key to continue..."
   echo
   echo "Retrieving payload repositories..."
   echo
   
   sudo pacman -Syyu --noconfirm --needed athena-payloadsallthethings athena-fuzzdb athena-auto-wordlists

   for i in "${!gitsource[@]}"
   do
      echo "Retrieving $i..."
      sudo git clone $i ${gitsource[$i]}
      echo
   done
   
   if [ ! -f /usr/share/payloads/SecLists/Passwords/Leaked-Databases/rockyou.txt ]
   then
       echo "Extracting rockyou.txt..."
       sudo tar -zxvf /usr/share/payloads/SecLists/Passwords/Leaked-Databases/rockyou.txt.tar.gz -C /usr/share/payloads/SecLists/Passwords/Leaked-Databases
   else
       echo "rockyou.txt found!"
   fi
   
   echo "Removing useless comments from directory list files..."
   sudo sed -i 's/^\#.*$//g' /usr/share/payloads/SecLists/Discovery/Web-Content/directory-list-2.3-small.txt && sudo sed -i '/^$/d' /usr/share/payloads/SecLists/Discovery/Web-Content/directory-list-2.3-small.txt
   sudo sed -i 's/^\#.*$//g' /usr/share/payloads/SecLists/Discovery/Web-Content/directory-list-2.3-medium.txt && sudo sed -i '/^$/d' /usr/share/payloads/SecLists/Discovery/Web-Content/directory-list-2.3-medium.txt
   sudo sed -i 's/^\#.*$//g' /usr/share/payloads/SecLists/Discovery/Web-Content/directory-list-2.3-big.txt && sudo sed -i '/^$/d' /usr/share/payloads/SecLists/Discovery/Web-Content/directory-list-2.3-big.txt
fi

sed -i "s/^role=.*/role=$role/g" $HOME/.config/athena-welcome/settings.conf

echo "All done. Your role has been set!"
read -p "Press enter to continue"
