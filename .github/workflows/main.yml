name: Build and Push Packages

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    container:
      image: athenaos/core:latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Install dependencies
      run: sudo pacman -Syyu --noconfirm pacman-contrib git
      
    - name: Setting builder user
      run: |
        sudo useradd builder
        echo "builder ALL=(ALL) NOPASSWD: ALL" | sudo tee -a /etc/sudoers
        sudo chmod -R a+rw .
        sudo chown -R builder .
        
    - name: Import GPG key
      uses: crazy-max/ghaction-import-gpg@v5
      with:
        gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
        passphrase: ${{ secrets.PACKAGE_SIGNING_PASSPHRASE }}

    - name: Build and sign packages
      run: |
        export PASSPHRASE=${{ secrets.PACKAGE_SIGNING_PASSPHRASE }}
        chmod +x build_and_sign_packages.sh
        chown -R builder ~/.gnupg/
        sudo -E -u builder ./build_and_sign_packages.sh

    - name: Push packages to another repository
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git clone https://github.com/Athena-OS/athena-repository-dev.git
        cd athena-repository-dev
        cp -rf ../*.pkg.tar.zst* ./x86_64/
        cp -rf ../*.pkg.tar.zst* ./aarch64/
        ./update-database.sh
        git add --all
        git commit -m "Add built packages"
        git push https://D3vil0p3r:${{ secrets.DESTINATION_REPO_TOKEN }}@github.com/Athena-OS/athena-repository-dev.git main
